steps:
  # Install Node.js dependencies
  - id: gcr.io/cloud-builders/npm
    name: node:12
    entrypoint: npm
    args:
      - install
    waitFor: ["-"]

  # Install Cloud SQL proxy
  - id: proxy-install
    name: gcr.io/cloud-builders/npm
    entrypoint: sh
    args:
      - "-c"
      - "wget https://storage.googleapis.com/cloudsql-proxy/v1.20.1/cloud_sql_proxy.linux.amd64 -O cloud_sql_proxy && chmod +x cloud_sql_proxy"
    waitFor: ["-"]

  # Migrate database schema to the latest version
  # https://knexjs.org/#Migrations-CLI
  - id: gcloud-install
    name: gcr.io/cloud-builders/npm
    entrypoint: sh
    args:
      - "-c"
      - "curl -O https://dl.google.com/dl/cloudsdk/channels/rapid/downloads/google-cloud-cli-387.0.0-linux-x86_64.tar.gz && tar -xf google-cloud-cli-387.0.0-linux-x86_64.tar.gz && ./google-cloud-sdk/install.sh -q"
    waitFor: ["-"]

  # Migrate database schema to the latest version
  # https://knexjs.org/#Migrations-CLI
  - id: migrate
    name: gcr.io/cloud-builders/npm
    entrypoint: sh
    args:
      - "-c"
      - "(./cloud_sql_proxy -dir=/cloudsql -instances=tcl-execrcies:us-central1:tcl-exercises=tcp:5432 & sleep 2);"
    timeout: "1200s"
    waitFor: ["npm-install", "proxy-install"]

timeout: "1200s"