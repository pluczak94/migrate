steps:
  - id: "docker-build"
    name: "gcr.io/cloud-builders/docker"
    args: ["build", "-t", "gcr.io/$PROJECT_ID/${_IMAGE_NAME}", "."]
#  - id: "docker-push"
#    name: "gcr.io/cloud-builders/docker"
#    args: ["push", "${_IMAGE_NAME}"]
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}'
    id: push image orginal
  - id: "docker-layer"
    name: "gcr.io/cloud-builders/docker"
    entrypoint: /bin/bash
    args:
      - '-c'
      - |
        echo "FROM gcr.io/$PROJECT_ID/${_IMAGE_NAME}
        RUN ls
        COPY --from=gcr.io/cloudsql-docker/gce-proxy /cloud_sql_proxy /cloudsql/cloud_sql_proxy
        RUN chmod 777 migrate.sh
        RUN ls -al
        ENTRYPOINT /migrate.sh"" > Dockerfile-proxy;
        docker build -f Dockerfile-proxy -t gcr.io/$PROJECT_ID/${_IMAGE_NAME}-proxy .
  # For TCP connections
  - name: gcr.io/cloud-builders/docker
    args:
      - push
      - 'gcr.io/$PROJECT_ID/${_IMAGE_NAME}-proxy'
    id: push image
  - id: "migrate-tcp"
    name: "gcr.io/$PROJECT_ID/${_IMAGE_NAME}-proxy"
options:
  dynamic_substitutions: true
timeout: "1200s"